<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UPrinting Automation Framework</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    <style>
        .option-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .option-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        .option-values {
            padding: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .progress-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1050;
            background: white;
            border-bottom: 1px solid #dee2e6;
            padding: 10px;
            display: none;
        }
        .status-badge {
            font-size: 0.8em;
        }
        .combination-count {
            font-weight: bold;
            color: #0d6efd;
        }
        .log-container {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="progress-container" id="progressContainer">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <div class="progress">
                        <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small id="progressMessage">Ready</small>
                </div>
                <div class="col-md-4 text-end">
                    <span id="progressStats">0 / 0</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">
                    <i class="fas fa-cogs"></i> UPrinting Automation Framework
                </h1>
            </div>
        </div>

        <!-- Step 1: Product Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-list"></i> Step 1: Select Product</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" class="form-control" id="productSearch" placeholder="Search products...">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-outline-secondary" id="clearSearchBtn">
                                    <i class="fas fa-times"></i> Clear
                                </button>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-8">
                                <select class="form-select" id="productSelect" size="5">
                                    <option value="">Loading products...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary" id="analyzeBtn" disabled>
                                    <i class="fas fa-search"></i> Analyze Product
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                Showing: <span id="productCount">0</span> products
                                <span id="searchInfo" style="display: none;"> (filtered from <span id="totalProducts">0</span>)</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 2: Analysis Results -->
        <div class="row mb-4" id="analysisSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-line"></i> Step 2: Review Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Product Information</h6>
                                <p><strong>Name:</strong> <span id="productName">-</span></p>
                                <p><strong>Product ID:</strong> <span id="productId">-</span></p>
                                <p><strong>Total Combinations:</strong> <span id="totalCombinations" class="combination-count">0</span></p>
                            </div>
                            <div class="col-md-6">
                                <h6>API Test Result</h6>
                                <p><strong>Status:</strong> <span id="apiTestStatus">-</span></p>
                                <p><strong>Sample Price:</strong> <span id="samplePrice">-</span></p>
                            </div>
                        </div>

                        <h6>Product Options</h6>
                        <div id="optionsContainer">
                            <!-- Options will be populated here -->
                        </div>

                        <div class="mt-3">
                            <button class="btn btn-success" id="startExtractionBtn" disabled>
                                <i class="fas fa-play"></i> Start Price Extraction
                            </button>
                            <button class="btn btn-warning" id="pauseExtractionBtn" style="display: none;">
                                <i class="fas fa-pause"></i> Pause Extraction
                            </button>
                            <button class="btn btn-info" id="resumeExtractionBtn" style="display: none;">
                                <i class="fas fa-play"></i> Resume Extraction
                            </button>
                            <button class="btn btn-secondary" id="modifyOptionsBtn">
                                <i class="fas fa-edit"></i> Modify Options
                            </button>
                            <button class="btn btn-outline-primary" id="addOptionBtn">
                                <i class="fas fa-plus"></i> Add Option
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 3: Extraction Results -->
        <div class="row mb-4" id="extractionSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-download"></i> Step 3: Download Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6>Extraction Statistics</h6>
                                <p><strong>Total Extracted:</strong> <span id="totalExtracted">0</span></p>
                                <p><strong>Success Rate:</strong> <span id="successRate">0%</span></p>
                                <p><strong>Errors:</strong> <span id="errorCount">0</span></p>
                            </div>
                            <div class="col-md-6">
                                <h6>Download Files</h6>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-outline-primary" id="downloadFormattedBtn" disabled>
                                        <i class="fas fa-table"></i> Download Formatted CSV
                                    </button>
                                    <button class="btn btn-outline-secondary" id="downloadRawBtn" disabled>
                                        <i class="fas fa-file-csv"></i> Download Raw CSV
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-terminal"></i> Activity Log</h6>
                    </div>
                    <div class="card-body">
                        <div class="log-container" id="logContainer">
                            <div>Framework initialized. Ready to analyze products.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Option Modification Modal -->
    <div class="modal fade" id="optionModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Modify Product Options</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="modalOptionsContainer">
                        <!-- Editable options will be populated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveOptionsBtn">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Option Modal -->
    <div class="modal fade" id="addOptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Option</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newOptionName" class="form-label">Option Name</label>
                        <input type="text" class="form-control" id="newOptionName" placeholder="e.g., Color, Finish">
                    </div>
                    <div class="mb-3">
                        <label for="newOptionValues" class="form-label">Option Values (one per line)</label>
                        <textarea class="form-control" id="newOptionValues" rows="5" placeholder="Red&#10;Blue&#10;Green"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="newOptionAttribute" class="form-label">Attribute Mapping (optional)</label>
                        <input type="text" class="form-control" id="newOptionAttribute" placeholder="e.g., attr7">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addOptionConfirmBtn">Add Option</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Sub-Option Modal -->
    <div class="modal fade" id="addSubOptionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Sub-Option</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="subOptionParent" class="form-label">Parent Option</label>
                        <input type="text" class="form-control" id="subOptionParent" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="subOptionValue" class="form-label">Sub-Option Value</label>
                        <input type="text" class="form-control" id="subOptionValue" placeholder="Enter new sub-option value">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="addSubOptionConfirmBtn">Add Sub-Option</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Initialize Socket.IO
        const socket = io();
        
        // Global variables
        let currentAnalysis = null;
        let currentExtraction = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadProducts();
            setupEventListeners();
            setupSearch();
        });
        
        // Socket event listeners
        socket.on('progress_update', function(data) {
            updateProgress(data);
        });
        
        socket.on('analysis_complete', function(data) {
            currentAnalysis = data;
            displayAnalysisResults(data);
        });
        
        socket.on('extraction_complete', function(data) {
            currentExtraction = data;
            displayExtractionResults(data);
        });
        
        // Load products from CSV
        function loadProducts(searchQuery = '') {
            const url = searchQuery ? `/api/products/search?q=${encodeURIComponent(searchQuery)}` : '/api/products';

            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateProductSelect(data.products);
                        document.getElementById('productCount').textContent = data.products.length;

                        if (searchQuery) {
                            document.getElementById('searchInfo').style.display = 'inline';
                            document.getElementById('totalProducts').textContent = data.total || 'unknown';
                            addLog(`Found ${data.products.length} products matching "${searchQuery}"`);
                        } else {
                            document.getElementById('searchInfo').style.display = 'none';
                            addLog(`Loaded ${data.total} products from CSV`);
                        }
                    } else {
                        addLog(`Error loading products: ${data.error}`, 'error');
                    }
                })
                .catch(error => {
                    addLog(`Error loading products: ${error}`, 'error');
                });
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.getElementById('productSearch');
            const clearBtn = document.getElementById('clearSearchBtn');

            let searchTimeout;

            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    const query = this.value.trim();
                    loadProducts(query);
                }, 300);
            });

            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                loadProducts();
            });
        }
        
        // Populate product select dropdown
        function populateProductSelect(products) {
            const select = document.getElementById('productSelect');
            select.innerHTML = '<option value="">Select a product...</option>';
            
            products.forEach((product, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = `${product['Product Name']} (${product['URL']})`;
                select.appendChild(option);
            });
            
            document.getElementById('analyzeBtn').disabled = false;
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('analyzeBtn').addEventListener('click', analyzeProduct);
            document.getElementById('startExtractionBtn').addEventListener('click', startExtraction);
            document.getElementById('pauseExtractionBtn').addEventListener('click', pauseExtraction);
            document.getElementById('resumeExtractionBtn').addEventListener('click', resumeExtraction);
            document.getElementById('modifyOptionsBtn').addEventListener('click', showOptionModal);
            document.getElementById('addOptionBtn').addEventListener('click', showAddOptionModal);
            document.getElementById('saveOptionsBtn').addEventListener('click', saveOptions);
            document.getElementById('addOptionConfirmBtn').addEventListener('click', addNewOption);
            document.getElementById('addSubOptionConfirmBtn').addEventListener('click', addNewSubOption);
            document.getElementById('downloadFormattedBtn').addEventListener('click', () => downloadFile('formatted'));
            document.getElementById('downloadRawBtn').addEventListener('click', () => downloadFile('raw'));
        }
        
        // Analyze selected product
        function analyzeProduct() {
            const productIndex = document.getElementById('productSelect').value;
            if (!productIndex) return;
            
            addLog(`Starting analysis for product index ${productIndex}`);
            showProgress();
            
            fetch(`/api/analyze/${productIndex}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        addLog('Analysis started successfully');
                    } else {
                        addLog(`Error starting analysis: ${data.error}`, 'error');
                        hideProgress();
                    }
                })
                .catch(error => {
                    addLog(`Error starting analysis: ${error}`, 'error');
                    hideProgress();
                });
        }
        
        // Display analysis results
        function displayAnalysisResults(analysis) {
            document.getElementById('productName').textContent = analysis.product_name;
            document.getElementById('productId').textContent = analysis.product_id;
            document.getElementById('totalCombinations').textContent = analysis.total_combinations.toLocaleString();
            
            // API test status
            const apiTest = analysis.api_test;
            const statusElement = document.getElementById('apiTestStatus');
            const priceElement = document.getElementById('samplePrice');
            
            if (apiTest.success) {
                statusElement.innerHTML = '<span class="badge bg-success">Success</span>';
                priceElement.textContent = `$${apiTest.price}`;
            } else {
                statusElement.innerHTML = '<span class="badge bg-danger">Failed</span>';
                priceElement.textContent = apiTest.error;
            }
            
            // Display options
            displayOptions(analysis.options);
            
            document.getElementById('analysisSection').style.display = 'block';
            document.getElementById('startExtractionBtn').disabled = !apiTest.success;
            
            addLog(`Analysis completed: ${Object.keys(analysis.options).length} option categories found`);
            hideProgress();
        }
        
        // Display options
        function displayOptions(options) {
            const container = document.getElementById('optionsContainer');
            container.innerHTML = '';
            
            Object.entries(options).forEach(([optionName, optionValues]) => {
                const optionCard = createOptionCard(optionName, optionValues);
                container.appendChild(optionCard);
            });
        }
        
        // Create option card with enhanced controls
        function createOptionCard(optionName, optionValues) {
            const card = document.createElement('div');
            card.className = 'option-card';

            const subOptionsHtml = optionValues.map(value => `
                <div class="d-flex align-items-center mb-1">
                    <span class="badge bg-light text-dark me-2">${value.text} (${value.id})</span>
                    <input type="checkbox" class="form-check-input suboption-exclude me-1"
                           data-option="${optionName}" data-suboption="${value.id}" data-text="${value.text}">
                    <label class="form-check-label me-2" style="font-size: 0.8em;">Exclude</label>
                </div>
            `).join('');

            card.innerHTML = `
                <div class="option-header">
                    <span><strong>${optionName}</strong> (${optionValues.length} options)</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" onclick="showAddSubOptionModal('${optionName}')">
                            <i class="fas fa-plus"></i> Add Sub-Option
                        </button>
                        <input type="checkbox" class="form-check-input option-exclude" data-option="${optionName}">
                        <label class="form-check-label ms-1">Exclude All</label>
                    </div>
                </div>
                <div class="option-values" style="max-height: 300px; overflow-y: auto;">
                    ${subOptionsHtml}
                </div>
            `;

            return card;
        }
        
        // Start price extraction
        function startExtraction() {
            const excludeOptions = Array.from(document.querySelectorAll('.option-exclude:checked'))
                .map(checkbox => checkbox.dataset.option);

            const excludeSuboptions = {};
            document.querySelectorAll('.suboption-exclude:checked').forEach(checkbox => {
                const option = checkbox.dataset.option;
                const suboption = checkbox.dataset.suboption;
                if (!excludeSuboptions[option]) {
                    excludeSuboptions[option] = [];
                }
                excludeSuboptions[option].push(suboption);
            });

            addLog(`Starting price extraction`);
            addLog(`Excluding options: ${excludeOptions.join(', ') || 'none'}`);
            addLog(`Excluding sub-options: ${JSON.stringify(excludeSuboptions)}`);

            showProgress();

            // Show pause button, hide start button
            document.getElementById('startExtractionBtn').style.display = 'none';
            document.getElementById('pauseExtractionBtn').style.display = 'inline-block';

            fetch('/api/extract/start', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    exclude_options: excludeOptions,
                    exclude_suboptions: excludeSuboptions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('‚úÖ Price extraction started successfully');
                } else {
                    addLog(`‚ùå Error starting extraction: ${data.error}`, 'error');
                    hideProgress();
                    resetExtractionButtons();
                }
            })
            .catch(error => {
                addLog(`‚ùå Error starting extraction: ${error}`, 'error');
                hideProgress();
                resetExtractionButtons();
            });
        }

        // Pause extraction
        function pauseExtraction() {
            fetch('/api/extract/pause', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('‚è∏Ô∏è Extraction paused');
                    document.getElementById('pauseExtractionBtn').style.display = 'none';
                    document.getElementById('resumeExtractionBtn').style.display = 'inline-block';
                } else {
                    addLog(`‚ùå Error pausing extraction: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`‚ùå Error pausing extraction: ${error}`, 'error');
            });
        }

        // Resume extraction
        function resumeExtraction() {
            fetch('/api/extract/resume', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog('‚ñ∂Ô∏è Extraction resumed');
                    document.getElementById('resumeExtractionBtn').style.display = 'none';
                    document.getElementById('pauseExtractionBtn').style.display = 'inline-block';
                } else {
                    addLog(`‚ùå Error resuming extraction: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`‚ùå Error resuming extraction: ${error}`, 'error');
            });
        }

        // Reset extraction buttons
        function resetExtractionButtons() {
            document.getElementById('startExtractionBtn').style.display = 'inline-block';
            document.getElementById('pauseExtractionBtn').style.display = 'none';
            document.getElementById('resumeExtractionBtn').style.display = 'none';
        }
        
        // Display extraction results
        function displayExtractionResults(extraction) {
            document.getElementById('totalExtracted').textContent = extraction.total_extracted.toLocaleString();
            document.getElementById('successRate').textContent = `${extraction.success_rate.toFixed(1)}%`;
            document.getElementById('errorCount').textContent = extraction.error_count;

            document.getElementById('downloadFormattedBtn').disabled = false;
            document.getElementById('downloadRawBtn').disabled = false;

            document.getElementById('extractionSection').style.display = 'block';

            addLog(`üéâ Extraction completed: ${extraction.total_extracted} combinations extracted`);
            resetExtractionButtons();
            hideProgress();
        }

        // Show add option modal
        function showAddOptionModal() {
            const modal = new bootstrap.Modal(document.getElementById('addOptionModal'));
            modal.show();
        }

        // Show add sub-option modal
        function showAddSubOptionModal(optionName) {
            document.getElementById('subOptionParent').value = optionName;
            const modal = new bootstrap.Modal(document.getElementById('addSubOptionModal'));
            modal.show();
        }

        // Add new option
        function addNewOption() {
            const optionName = document.getElementById('newOptionName').value.trim();
            const optionValuesText = document.getElementById('newOptionValues').value.trim();
            const attributeMapping = document.getElementById('newOptionAttribute').value.trim();

            if (!optionName || !optionValuesText) {
                alert('Please provide option name and values');
                return;
            }

            const optionValues = optionValuesText.split('\n').map(v => v.trim()).filter(v => v);

            addLog(`Adding new option: ${optionName} with ${optionValues.length} values`);

            fetch('/api/analysis/add_option', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    option_name: optionName,
                    option_values: optionValues,
                    attribute_mapping: attributeMapping || null
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`‚úÖ Added option "${optionName}" successfully`);
                    if (data.found_ids) {
                        addLog(`üîç Found IDs: ${JSON.stringify(data.found_ids)}`);
                    }

                    // Update current analysis
                    currentAnalysis = data.analysis;
                    displayAnalysisResults(currentAnalysis);

                    // Close modal and clear form
                    bootstrap.Modal.getInstance(document.getElementById('addOptionModal')).hide();
                    document.getElementById('newOptionName').value = '';
                    document.getElementById('newOptionValues').value = '';
                    document.getElementById('newOptionAttribute').value = '';
                } else {
                    addLog(`‚ùå Error adding option: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`‚ùå Error adding option: ${error}`, 'error');
            });
        }

        // Add new sub-option
        function addNewSubOption() {
            const optionName = document.getElementById('subOptionParent').value;
            const subOptionValue = document.getElementById('subOptionValue').value.trim();

            if (!subOptionValue) {
                alert('Please provide sub-option value');
                return;
            }

            addLog(`Adding sub-option "${subOptionValue}" to "${optionName}"`);

            fetch('/api/analysis/add_suboption', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    option_name: optionName,
                    suboption_value: subOptionValue
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addLog(`‚úÖ Added sub-option "${subOptionValue}" successfully`);
                    if (data.found_id) {
                        addLog(`üîç Found ID: ${data.found_id}`);
                    }

                    // Update current analysis
                    currentAnalysis = data.analysis;
                    displayAnalysisResults(currentAnalysis);

                    // Close modal and clear form
                    bootstrap.Modal.getInstance(document.getElementById('addSubOptionModal')).hide();
                    document.getElementById('subOptionValue').value = '';
                } else {
                    addLog(`‚ùå Error adding sub-option: ${data.error}`, 'error');
                }
            })
            .catch(error => {
                addLog(`‚ùå Error adding sub-option: ${error}`, 'error');
            });
        }
        
        // Update progress
        function updateProgress(data) {
            const progressBar = document.getElementById('progressBar');
            const progressMessage = document.getElementById('progressMessage');
            const progressStats = document.getElementById('progressStats');

            const percentage = data.total > 0 ? (data.progress / data.total) * 100 : 0;

            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage.toFixed(1)}%`;

            // Update progress bar color based on status
            if (data.is_paused) {
                progressBar.className = 'progress-bar bg-warning';
                progressMessage.textContent = '‚è∏Ô∏è ' + data.message;
            } else if (data.current_step === 'completed') {
                progressBar.className = 'progress-bar bg-success';
                progressMessage.textContent = '‚úÖ ' + data.message;
            } else {
                progressBar.className = 'progress-bar bg-primary';
                progressMessage.textContent = data.message;
            }

            progressStats.textContent = `${data.progress.toLocaleString()} / ${data.total.toLocaleString()}`;

            // Update button states based on pause status
            if (data.is_paused) {
                document.getElementById('pauseExtractionBtn').style.display = 'none';
                document.getElementById('resumeExtractionBtn').style.display = 'inline-block';
            } else if (data.current_step === 'extracting') {
                document.getElementById('pauseExtractionBtn').style.display = 'inline-block';
                document.getElementById('resumeExtractionBtn').style.display = 'none';
            }
        }
        
        // Show/hide progress
        function showProgress() {
            document.getElementById('progressContainer').style.display = 'block';
        }
        
        function hideProgress() {
            document.getElementById('progressContainer').style.display = 'none';
        }
        
        // Add log entry
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            
            const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            logEntry.innerHTML = `<span class="text-muted">[${timestamp}]</span> ${icon} ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // Show option modification modal
        function showOptionModal() {
            // Implementation for option modification
            const modal = new bootstrap.Modal(document.getElementById('optionModal'));
            modal.show();
        }
        
        // Save modified options
        function saveOptions() {
            // Implementation for saving modified options
            addLog('Option modification not yet implemented');
        }
        
        // Download file
        function downloadFile(type) {
            if (!currentExtraction) return;
            
            const filename = type === 'formatted' ? 
                currentExtraction.formatted_csv_path : 
                currentExtraction.raw_csv_path;
            
            window.open(`/api/download/${filename}`, '_blank');
            addLog(`Downloaded ${type} CSV file`);
        }
    </script>
</body>
</html>
